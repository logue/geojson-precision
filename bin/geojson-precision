#!/usr/bin/env node

import parse from '../dist/geojson-precision';
import { readFile, writeFile } from 'node:fs';
import { join } from 'node:path';
import { usage, args, help, precision, extrasPrecision } from 'commander';

usage('[coordinatePrecision] [extrasPrecision] input output')
  .option(
    '-p, --precision [coordinatePrecision]',
    'Output precision, defaults to 6',
    6
  )
  .option(
    '-e, --extras-precision [extrasPrecision]',
    'Output precision for extra coordinates beyond X and Y, such as Z. Defaults to 2',
    2
  )
  .parse(process.argv);

if (args.length < 2) {
  console.error('An input and output file is required');
  help();
} else {
  const inputPath =
    args[0].indexOf('/') < 0 ? join(process.cwd(), args[0]) : args[0];

  readFile(inputPath, (readError, data) => {
    if (readError) {
      console.error(readError);
      help();
    }
    const outPath =
      args[1].indexOf('/') < 0 ? join(process.cwd(), args[1]) : args[1];

    writeFile(
      outPath,
      JSON.stringify(parse(JSON.parse(data), precision, extrasPrecision)),
      error => {
        if (error) {
          console.error(error);
          help();
          return;
        }
        process.exit();
      }
    );
  });
}
